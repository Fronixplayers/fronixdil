<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Student Dashboard - FronixLearner</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary: #4318FF; --bg: #f4f7fe; --white: #fff; --text: #1B2559; --success: #05CD99; --warning: #FFB547; --danger: #EE5D50; }
        * { box-sizing: border-box; }
        body { background: var(--bg); font-family: 'Montserrat', sans-serif; display: flex; margin: 0; min-height: 100vh; overflow-x: hidden; }
        
        /* --- SIDEBAR --- */
        aside { width: 280px; background: var(--white); padding: 25px; display: flex; flex-direction: column; position: fixed; height: 100%; border-right: 1px solid #e2e8f0; z-index: 50; transition: transform 0.3s ease; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; color: #8f9bba; border-radius: 12px; font-weight: 600; display: flex; gap: 12px; align-items: center; transition: 0.3s; }
        .nav-item.active, .nav-item:hover { background: #f4f7fe; color: var(--primary); }
        
        .wallet-card { background: linear-gradient(135deg, var(--primary), #2B0EAE); padding: 20px; border-radius: 20px; color: white; margin-top: auto; text-align: center; box-shadow: 0 10px 20px rgba(67, 24, 255, 0.3); }
        
        /* --- MAIN --- */
        main { flex: 1; padding: 30px; margin-left: 280px; overflow-y: auto; height: 100vh; position: relative; z-index: 1; }
        .mobile-menu-btn { display: none; position: fixed; top: 20px; right: 20px; z-index: 60; background: var(--white); padding: 10px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; }

        .header-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); cursor: pointer; transition: 0.2s; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .card { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.3s; position: relative; border: 1px solid transparent; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .thumbnail { width: 100%; height: 160px; border-radius: 15px; margin-bottom: 15px; background-size: cover; background-position: center; position: relative; }
        
        /* --- ASSIGNMENT MARKETPLACE STYLES --- */
        .market-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .job-card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .job-status { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; background: #eee; font-weight: bold; }
        .status-open { background: #dcfce7; color: var(--success); }
        
        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 600px; max-width: 90%; border-radius: 20px; padding: 30px; position: relative; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #888; }
        
        /* Leaderboard Items */
        .lb-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; border-radius: 8px; }
        .lb-item:hover { background: #f8fafc; }
        .lb-user { flex: 1; display: flex; align-items: center; gap: 10px; }
        .lb-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; }

        /* Profile Tabs */
        .profile-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .p-tab { padding: 10px; cursor: pointer; font-weight: 600; color: #888; border-bottom: 2px solid transparent; }
        .p-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .avatar-option { width: 100%; aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .avatar-option.selected { border-color: var(--primary); box-shadow: 0 0 10px rgba(67,24,255,0.3); }

        /* Course Player & Interaction */
        #courseModal .modal-container { width: 95%; height: 90%; background: #111; border-radius: 20px; display: flex; overflow: hidden; border: 1px solid #333; position: relative; }
        .video-section { flex: 2; background: black; display: flex; flex-direction: column; }
        iframe { flex: 1; border: none; }
        .video-controls { padding: 15px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #333; }
        .interaction-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; margin-right: 10px; transition: 0.2s; }
        .interaction-btn:hover, .interaction-btn.active { background: var(--primary); }

        .interactive-section { flex: 1; background: white; display: flex; flex-direction: column; min-width: 350px; max-width: 400px; }
        .tabs { display: flex; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; color: #888; background: #f8fafc; transition: 0.3s; font-size: 0.9rem; }
        .tab.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { flex: 1; overflow-y: auto; padding: 20px; display: none; background: #f8fafc; }
        .tab-content.active { display: block; }
        
        .drive-locked { padding: 20px; background: #fff1f2; color: #be123c; border-radius: 10px; text-align: center; border: 1px solid #fda4af; }
        .drive-unlocked { padding: 20px; background: #f0fdf4; color: #15803d; border-radius: 10px; text-align: center; border: 1px solid #86efac; cursor: pointer; }

        /* NEW: Withdrawal History Styles */
        .history-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .w-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
        .w-pending { background: #fff7ed; color: #c2410c; }
        .w-paid { background: #dcfce7; color: #16a34a; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 900px) { aside { transform: translateX(-100%); } aside.open { transform: translateX(0); } main { margin-left: 0; padding: 15px; } .modal-container { flex-direction: column; } .interactive-section { height: 50%; } }
    </style>
</head>
<body>

    <div class="mobile-menu-btn" onclick="document.querySelector('aside').classList.toggle('open')"><i class="fas fa-bars"></i></div>

    <div class="modal-overlay" id="leaderboardModal">
        <div class="modal-box">
            <span class="modal-close-btn" onclick="document.getElementById('leaderboardModal').style.display='none'">&times;</span>
            <h2 style="color:var(--text); margin:0;"><i class="fas fa-trophy" style="color:#f59e0b;"></i> Top Students</h2>
            <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Ranking based on XP earned.</p>
            <div id="lbList">Loading...</div>
        </div>
    </div>

    <div class="modal-overlay" id="profileModal">
        <div class="modal-box">
            <span class="modal-close-btn" onclick="document.getElementById('profileModal').style.display='none'">&times;</span>
            <div style="text-align:center; margin-bottom:20px;">
                <img id="profileCurrentAvatar" src="" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px; border:3px solid var(--primary);">
                <h2 id="profileNameDisplay" style="margin:0; color:var(--text);">User</h2>
                <p id="verificationStatus" style="font-size:0.9rem; color:#888;">Unverified Student</p>
            </div>
            
            <div class="profile-tabs">
                <div class="p-tab active" onclick="switchProfileTab('edit')">Edit Profile</div>
                <div class="p-tab" onclick="switchProfileTab('certs')">Certificates</div>
                <div class="p-tab" onclick="switchProfileTab('id')">ID Verification</div>
            </div>

            <div id="tab-edit" style="display:block;">
                <label style="font-weight:600; display:block; margin-bottom:10px;">Choose Avatar</label>
                <div class="avatar-grid" id="avatarGrid"></div>
                <label style="font-weight:600; display:block; margin-bottom:5px;">Full Name</label>
                <input type="text" id="settingsName" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
                <label style="font-weight:600; display:block; margin-bottom:5px;">Bio</label>
                <textarea id="settingsBio" rows="2" placeholder="Tell us about yourself..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;"></textarea>
                <button onclick="window.saveProfile()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Save Changes (DB)</button>
            </div>

            <div id="tab-certs" style="display:none;">
                <div id="walletList"></div>
            </div>

            <div id="tab-id" style="display:none;">
                <div style="background:#f8fafc; padding:15px; border-radius:10px;">
                    <h3 style="margin-top:0;">College ID Verification</h3>
                    <p style="font-size:0.85rem; color:#666;">Upload your College ID to unlock Google Drive resources and premium assignments.</p>
                    <div id="uploadSection">
                        <input type="file" id="idProofInput" accept="image/*" style="margin-bottom:10px;">
                        <button onclick="window.submitVerification()" class="interaction-btn" style="background:var(--primary); width:100%;">Submit ID (DB)</button>
                    </div>
                    <div id="pendingMsg" style="display:none; color:var(--warning); font-weight:bold;"><i class="fas fa-clock"></i> Verification Pending Approval</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="assignmentModal">
        <div class="modal-box">
            <span class="modal-close-btn" onclick="document.getElementById('assignmentModal').style.display='none'">&times;</span>
            <h2><i class="fas fa-briefcase"></i> Post New Assignment</h2>
            <p style="font-size:0.9rem; color:#666;">Funds will be held in Escrow until you approve the work.</p>
            <input type="text" id="jobTitle" placeholder="Assignment Title" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
            <textarea id="jobDesc" rows="4" placeholder="Detailed requirements..." style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;"></textarea>
            <input type="number" id="jobBudget" placeholder="Budget ($)" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
            <button onclick="window.postAssignment()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">Post Job (DB)</button>
        </div>
    </div>

    <div class="modal-overlay" id="withdrawModal">
        <div class="modal-box">
            <span class="modal-close-btn" onclick="document.getElementById('withdrawModal').style.display='none'">&times;</span>
            <h2><i class="fas fa-wallet"></i> Request Withdrawal</h2>
            <p>Available Balance: <strong id="modalBalance">$0.00</strong></p>
            
            <div style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:20px;">
                <input type="number" id="withdrawAmount" placeholder="Amount to withdraw" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
                <input type="text" id="upiId" placeholder="UPI ID / PayPal Email" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
                <button onclick="window.requestWithdrawal()" style="width:100%; padding:15px; background:var(--success); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">Submit Request</button>
            </div>

            <h3>History</h3>
            <div id="withdrawalHistory" style="max-height:150px; overflow-y:auto; border-top:1px solid #eee;">
                <p style="color:#999; text-align:center; padding:10px;">Loading history...</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="courseModal" style="z-index: 2500;">
        <div style="position:absolute; top:20px; right:20px; z-index:2600;">
            <button onclick="window.closeCourseModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-container">
            <div class="video-section">
                <iframe id="playerFrame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                <div class="video-controls">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:white; font-weight:600;" id="currentLessonTitle">Lesson Player</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="interaction-btn" onclick="window.toggleLike()"><i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span></button>
                    </div>
                </div>
            </div>
            <div class="interactive-section">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('lessons')">Lessons</div>
                    <div class="tab" onclick="switchTab('drive')">Resources</div>
                    <div class="tab" onclick="switchTab('chat')">Discuss</div>
                </div>
                <div id="lessonsTab" class="tab-content active"><div id="playlistContainer"></div></div>
                <div id="driveTab" class="tab-content"><div id="driveAccessMsg"></div></div>
                <div id="chatTab" class="tab-content">
                    <div id="chatList"></div>
                    <div style="display:flex; margin-top:10px;">
                        <input type="text" id="interactionInput" placeholder="Ask a question..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
                        <button onclick="window.handleSend()" style="padding:10px; background:var(--primary); color:white; border:none; border-radius:5px; margin-left:5px;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside>
        <div class="logo"><i class="fas fa-atom"></i> Fronix</div>
        <div class="nav-item active" onclick="switchView('courses')"><i class="fas fa-book-open"></i> Learning</div>
        <div class="nav-item" onclick="switchView('assignments')"><i class="fas fa-briefcase"></i> Assignments</div>
        <div class="nav-item" onclick="window.openLeaderboard()"><i class="fas fa-trophy"></i> Leaderboard</div>
        <div class="nav-item" onclick="window.openProfile()"><i class="fas fa-id-card"></i> Profile & ID</div>
        
        <div class="wallet-card">
            <p style="font-size:0.8rem; opacity:0.8;">MY WALLET</p>
            <h1 id="walletBalance" style="margin:5px 0;">$0.00</h1>
            <button onclick="document.getElementById('withdrawModal').style.display='flex'" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:5px 15px; border-radius:15px; font-size:0.8rem; cursor:pointer; margin-top:10px;">Withdraw</button>
        </div>
        <div class="nav-item" style="margin-top:20px; color:#ef4444;" onclick="window.logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </aside>

    <main>
        <div class="header-stats">
            <div class="stat-box" onclick="window.openProfile()">
                <div class="stat-icon" style="background:#e0e7ff; color:var(--primary);"><img id="headerAvatar" src="" style="width:100%; border-radius:12px;"></div>
                <div><h3 style="margin:0;" id="welcomeName">Student</h3><p style="margin:0; color:#888; font-size:0.8rem;">View Profile</p></div>
            </div>
            <div class="stat-box">
                <div class="stat-icon" style="background:#dcfce7; color:#10b981;"><i class="fas fa-check-circle"></i></div>
                <div><h3 style="margin:0;" id="verifiedBadge">No</h3><p style="margin:0; color:#888; font-size:0.9rem;">College Verified</p></div>
            </div>
        </div>

        <div id="viewCourses">
            <h2 style="margin-bottom:20px;">Your Learning Path</h2>
            <div class="grid" id="courseGrid"></div>
        </div>

        <div id="viewAssignments" style="display:none;">
            <div class="market-header">
                <h2>Assignment Marketplace</h2>
                <button onclick="document.getElementById('assignmentModal').style.display='flex'" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;"><i class="fas fa-plus"></i> Post Request</button>
            </div>
            <div id="assignmentList"><p>Loading market data...</p></div>
        </div>
    </main>

    <script type="module">
        import { auth, db, onAuthStateChanged, signOut, collection, addDoc, getDoc, getDocs, doc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, increment, where, limit } from './firebase-config.js';

        let currentUser = null;
        let currentCourseId = null;
        let currentPlaylist = [];
        let selectedAvatar = "";
        const avatarSeeds = ['Felix', 'Aneka', 'Mittens', 'Bubba', 'Sorelle', 'Destiny'];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // --- 1. REAL-TIME USER DATA LISTENER ---
                // We use onSnapshot instead of getDoc so walletBalance updates instantly
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if(docSnap.exists()) {
                        currentUser = { ...docSnap.data(), uid: user.uid };
                        if(!currentUser.avatar) currentUser.avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`;
                        updateUI();
                        // Load these only once or when appropriate
                        loadCourses(); 
                        loadAssignments();
                        loadWithdrawalHistory(); // New Function
                    }
                });
            } else window.location.href = 'index.html';
        });

        function updateUI() {
            document.getElementById('welcomeName').innerText = currentUser.name;
            document.getElementById('headerAvatar').src = currentUser.avatar;
            document.getElementById('walletBalance').innerText = `$${currentUser.walletBalance || 0}`;
            document.getElementById('modalBalance').innerText = `$${currentUser.walletBalance || 0}`;
            document.getElementById('verifiedBadge').innerText = currentUser.isVerified ? "Yes" : "No";
            document.getElementById('verificationStatus').innerText = currentUser.isVerified ? "Verified Student" : (currentUser.verificationPending ? "Verification Pending" : "Unverified");
            
            if(currentUser.isVerified || currentUser.verificationPending) {
                document.getElementById('uploadSection').style.display = 'none';
                if(currentUser.verificationPending) document.getElementById('pendingMsg').style.display = 'block';
            }
        }

        window.switchView = (view) => {
            document.getElementById('viewCourses').style.display = view === 'courses' ? 'block' : 'none';
            document.getElementById('viewAssignments').style.display = view === 'assignments' ? 'block' : 'none';
        };

        // --- 1. LEADERBOARD ---
        window.openLeaderboard = () => {
            document.getElementById('leaderboardModal').style.display = 'flex';
            const list = document.getElementById('lbList');
            const q = query(collection(db, "users"), where("role", "==", "Student"), orderBy("xp", "desc"), limit(10));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                let r = 1;
                snap.forEach(d => {
                    const u = d.data();
                    list.innerHTML += `
                    <div class="lb-item">
                        <div style="font-weight:bold; width:30px;">#${r++}</div>
                        <div class="lb-user"><img class="lb-avatar" src="${u.avatar}"> <span>${u.name}</span></div>
                        <div style="font-weight:bold; color:#f59e0b;">${u.xp || 0} XP</div>
                    </div>`;
                });
            });
        };

        // --- 2. PROFILE & ID ---
        window.openProfile = () => {
            document.getElementById('profileModal').style.display = 'flex';
            document.getElementById('profileNameDisplay').innerText = currentUser.name;
            document.getElementById('profileCurrentAvatar').src = currentUser.avatar;
            document.getElementById('settingsName').value = currentUser.name;
            document.getElementById('settingsBio').value = currentUser.bio || "";
            
            const grid = document.getElementById('avatarGrid'); grid.innerHTML = "";
            avatarSeeds.forEach(seed => {
                const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`;
                grid.innerHTML += `<img src="${url}" class="avatar-option" onclick="window.selectAvatar(this, '${url}')">`;
            });
            loadCertificateWallet();
        };

        window.switchProfileTab = (tabName) => {
            document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#tab-edit, #tab-certs, #tab-id').forEach(d => d.style.display = 'none');
            
            if(tabName === 'edit') { document.getElementById('tab-edit').style.display='block'; event.target.classList.add('active'); }
            if(tabName === 'certs') { document.getElementById('tab-certs').style.display='block'; event.target.classList.add('active'); }
            if(tabName === 'id') { document.getElementById('tab-id').style.display='block'; event.target.classList.add('active'); }
        };

        window.selectAvatar = (el, url) => {
            document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
            el.classList.add('selected');
            selectedAvatar = url;
        };

        window.saveProfile = async () => {
            const newName = document.getElementById('settingsName').value;
            const newBio = document.getElementById('settingsBio').value;
            await updateDoc(doc(db, "users", currentUser.uid), { name: newName, bio: newBio, avatar: selectedAvatar || currentUser.avatar });
            alert("Profile Updated!");
            location.reload();
        };

        async function loadCertificateWallet() {
            const list = document.getElementById('walletList'); list.innerHTML = "";
            const ids = currentUser.completedCourses || [];
            if(ids.length === 0) return list.innerHTML = "<p style='color:#999; text-align:center;'>No certificates yet.</p>";
            for(const id of ids) {
                const cDoc = await getDoc(doc(db, "courses", id));
                if(cDoc.exists()) {
                    list.innerHTML += `<div style="padding:10px; border:1px solid #eee; margin-bottom:5px; border-radius:5px;"><i class="fas fa-certificate" style="color:#fbbf24;"></i> ${cDoc.data().title}</div>`;
                }
            }
        }

        window.submitVerification = async () => {
            const file = document.getElementById('idProofInput').files[0];
            if(!file) return alert("Please select an image file.");
            const fakeUrl = "https://example.com/id-proof.jpg"; 
            await updateDoc(doc(db, "users", currentUser.uid), { verificationPending: true, idProofUrl: fakeUrl, submittedAt: serverTimestamp() });
            currentUser.verificationPending = true;
            updateUI();
            alert("ID Submitted! Admin will review shortly.");
        };

        // --- 3. COURSES & PLAYER ---
        function loadCourses() {
            onSnapshot(query(collection(db, "courses"), orderBy("createdAt", "desc")), (snap) => {
                const g = document.getElementById('courseGrid'); g.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    const v = (c.playlist && c.playlist.length) ? c.playlist[0].videoId : c.videoId;
                    g.innerHTML += `
                    <div class="card" onclick="window.openCourse('${d.id}')" style="cursor:pointer;">
                        <div class="thumbnail" style="background-image:url('https://img.youtube.com/vi/${v}/hqdefault.jpg');"></div>
                        <h4>${c.title}</h4>
                        <p style="color:#888; font-size:0.8rem;">${c.instructor}</p>
                    </div>`;
                });
            });
        }

        window.openCourse = async (id) => {
            currentCourseId = id;
            document.getElementById('courseModal').style.display = 'flex';
            const d = await getDoc(doc(db, "courses", id));
            const c = d.data();
            currentPlaylist = c.playlist || [{title:"Lesson 1", videoId:c.videoId}];
            document.getElementById('likeCount').innerText = c.likes || 0;
            window.loadVideo(0);
            window.switchTab('lessons');
        };

        window.loadVideo = (idx) => {
            document.getElementById('playerFrame').src = `https://www.youtube.com/embed/${currentPlaylist[idx].videoId}`;
            document.getElementById('playlistContainer').innerHTML = currentPlaylist.map((l, i) => 
                `<div onclick="window.loadVideo(${i})" style="padding:10px; cursor:pointer; background:${i===idx?'#eef2ff':'white'};">${i+1}. ${l.title}</div>`
            ).join('');
        };

        window.switchTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(t+'Tab').classList.add('active');
            if(t === 'drive') {
                const div = document.getElementById('driveAccessMsg');
                if(currentUser.isVerified) div.innerHTML = `<div class="drive-unlocked" onclick="window.open('https://drive.google.com', '_blank')"><i class="fab fa-google-drive"></i> Access Course Resources (Verified)</div>`;
                else div.innerHTML = `<div class="drive-locked"><i class="fas fa-lock"></i> Verification Required. Please upload ID in Profile tab.</div>`;
            } else if (t === 'chat') { loadComments(); }
        };

        window.toggleLike = async () => {
            await updateDoc(doc(db, "courses", currentCourseId), { likes: increment(1) });
            document.getElementById('likeCount').innerText = parseInt(document.getElementById('likeCount').innerText) + 1;
        };

        function loadComments() {
            onSnapshot(query(collection(db, "comments"), where("courseId", "==", currentCourseId), orderBy("createdAt", "asc")), (snap) => {
                const l = document.getElementById('chatList'); l.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    l.innerHTML += `<div style="margin-bottom:10px; font-size:0.9rem;"><strong>${m.userName}:</strong> ${m.text}</div>`;
                });
            });
        }

        window.handleSend = async () => {
            const txt = document.getElementById('interactionInput').value;
            if(!txt) return;
            await addDoc(collection(db, "comments"), { courseId: currentCourseId, text: txt, userName: currentUser.name, createdAt: serverTimestamp() });
            document.getElementById('interactionInput').value = "";
        };

        // --- 4. MARKETPLACE ---
        window.postAssignment = async () => {
            const title = document.getElementById('jobTitle').value;
            const desc = document.getElementById('jobDesc').value;
            const budget = parseFloat(document.getElementById('jobBudget').value);
            if(!title || !budget) return alert("Please fill all fields");

            await addDoc(collection(db, "assignments"), {
                buyerId: currentUser.uid, buyerName: currentUser.name, title: title, description: desc,
                budget: budget, status: 'open', createdAt: serverTimestamp()
            });
            document.getElementById('assignmentModal').style.display='none';
            alert("Assignment Posted! Sellers can now apply.");
        };

        function loadAssignments() {
            onSnapshot(query(collection(db, "assignments"), orderBy("createdAt", "desc")), (snap) => {
                const l = document.getElementById('assignmentList'); l.innerHTML = "";
                snap.forEach(d => {
                    const j = d.data();
                    l.innerHTML += `
                    <div class="job-card">
                        <div style="display:flex; justify-content:space-between;"><h3>${j.title}</h3><span class="job-status status-open">${j.status.toUpperCase()}</span></div>
                        <p>${j.description}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                            <strong style="color:var(--primary);">$${j.budget}</strong>
                            <span style="font-size:0.8rem; color:#888;">Posted by ${j.buyerName}</span>
                        </div>
                    </div>`;
                });
            });
        }
        
        // --- 5. WITHDRAWALS (REAL-TIME UPDATE) ---
        window.requestWithdrawal = async () => {
            const amt = parseFloat(document.getElementById('withdrawAmount').value);
            const upi = document.getElementById('upiId').value;
            
            if(!amt || amt <= 0) return alert("Enter valid amount");
            if(amt > (currentUser.walletBalance || 0)) return alert("Insufficient funds!");
            if(!upi) return alert("Enter payment details");

            // 1. DEDUCT BALANCE IMMEDIATELY
            await updateDoc(doc(db, "users", currentUser.uid), {
                walletBalance: increment(-amt)
            });

            // 2. CREATE REQUEST RECORD
            await addDoc(collection(db, "withdrawals"), { 
                userId: currentUser.uid, 
                amount: amt, 
                method: upi, 
                status: 'pending', 
                createdAt: serverTimestamp() 
            });

            alert("Withdrawal requested! Funds deducted.");
            document.getElementById('withdrawAmount').value = "";
            // Modal stays open so they can see the new history item appear
        };

        function loadWithdrawalHistory() {
            const histDiv = document.getElementById('withdrawalHistory');
            const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snap) => {
                histDiv.innerHTML = "";
                if(snap.empty) {
                    histDiv.innerHTML = "<p style='color:#999; text-align:center; padding:10px;'>No withdrawals yet.</p>";
                    return;
                }

                snap.forEach(d => {
                    const w = d.data();
                    const badgeClass = w.status === 'paid' ? 'w-paid' : 'w-pending';
                    const badgeText = w.status === 'paid' ? 'PAID' : 'PENDING';
                    
                    histDiv.innerHTML += `
                    <div class="history-item">
                        <div>
                            <strong>$${w.amount}</strong> <span style="color:#888; font-size:0.8rem;"> via ${w.method}</span>
                        </div>
                        <span class="w-badge ${badgeClass}">${badgeText}</span>
                    </div>`;
                });
            });
        }

        window.closeCourseModal = () => document.getElementById('courseModal').style.display = 'none';
        window.logout = () => signOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>